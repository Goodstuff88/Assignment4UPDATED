---
title: "Assignment 4"
author: "Gustav Oosthuizen - OSTGUS001"
date: '`r format(Sys.Date(), "%d-%B-%Y")`'
output:
  pdf_document:
    highlight: pygments
    keep_tex: yes
    number_sections: yes
    toc: yes
    toc_depth: 4
    fig_caption: true
citation_package: "biblatex"
bibliography: "Ass_4.bib"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

\pagebreak

```{r Installing packages, include=FALSE}

# Steps:

# 1. Installing packages used for analysis:

# 1.1 General use

#install.packages("tidyverse")
#install.packages("remotes")
#install.packages("rgdal")
#install.packages("devtools")
#install.packages("RColorBrewer")
#install.packages("ggedit")
#install.packages("caTools")
#install.packages("plotly")
#install.packages("gridExtra")
#install.packages("egg")
#install.packages("cowplot")
#install.packages("ggrepel")

library(ggrepel)
library(cowplot)
library(tidyverse)
library(remotes)
library(rgdal)
library(devtools)
library(RColorBrewer)
library(ggedit)
library(caTools)
library(plotly)
library(gridExtra)
library(egg)

# 1.2 Mapping data and working with spatial objects

#install.packages("spdplyr")
#install.packages("sf")
#install.packages("countrycode")
#install.packages("ggmap")
#install.packages("rnaturalearth")
#install.packages("rnaturalearthdata")
#install.packages("mapdata")
#intall,packages("leaflet")

library(spdplyr)
library(sf)
library(countrycode)
library(ggmap)
library(rnaturalearth)
library(rnaturalearthdata)
library(leaflet)
library(mapdata)

# 1.3 Creating animations

#install.packages("gganimate")
#install.packages("gifski")


library(gifski)
library(gganimate)

# 1.4 Creating Shiny dashboard


#install.packages("shiny")
#install.packages("shinydashboard")
#install.packages("DT")
#install.packages("shinyWidgets")
#install.packages("shinybusy")



library(shinybusy)
library(shinyWidgets)
library(shinydashboard)
library(DT)
library(shiny)

```


\section{Data wrangling} \label{DW section}

The data wrangling consist of importing, tidying and transforming the data set [@wickham2016r].

\subsection{Imporing data} 

As mentioned in section \ref{DW section} the first step of data wrangling is importing the data.

***** START CODE - for reproduceability *****

```{r Loading covid 19 data}

# Note: The original data file will be attached for reproducability.

# Steps:

# 1. Loading data 


# 1.1 Covid 19 data up to the 23/03/2020 (Most code written for this data set)

# ncov_new <- read.csv(file = "time_series_19_covid_combined_23_03_2020.csv", stringsAsFactors = FALSE)


# 1.2 Covid 19 data up to the 15/04/2020 (Test data set)

ncov_new <- read.csv(file = "time_series_19_covid_combined_15_04_2020.csv", stringsAsFactors = FALSE)

```


\subsection{Tiding and transforming the data}

The second and thrid steps of data wrangling is tiding and transforming the data. The variables of the "ncovr_new" data set will be investigated and the nesseccary changes/transformations will be made to get the data in a tidy format.   


```{r Investigating variables and treating missing values in data sets}

# Steps:

# 1. Investigating type and structre of data

glimpse(ncov_new)

str(ncov_new)

# Remark: The "Date" variable should of type date not character:


# 2. Checking for NA values in data set

sum(is.na(ncov_new$Province.State))
sum(is.na(ncov_new$Country.Region))
sum(is.na(ncov_new$Lat))
sum(is.na(ncov_new$Long))
sum(is.na(ncov_new$Date))
sum(is.na(ncov_new$Confirmed))
sum(is.na(ncov_new$Recovered))
sum(is.na(ncov_new$Deaths))

# Remark: The "Confirmed" and Deaths variables seem to have missing values

# 2.1 Looking at missing value instances

ncov_new %>% 
  filter(is.na(Confirmed))

# Remark: It seems to be associated with a sertain location in Canada. The "Recovered" variable is populated but not the "Deaths" or "Confirmed" variables. It would be best to totally ignore these instances since they offer no value. All three variables need to be known for data to be useful.

# 3. Remove instances with NA values

ncov_new <- na.omit(ncov_new)


```


```{r Additions and transformations to data set}

# Steps:

# 1. Changing the format of the "Date" variable

ncov_new$Date <- as.Date(ncov_new$Date,)

# 2. Adding a variable "Infected" which is the number of accounts of people that are still undergoing treatment.

ncov_new <- ncov_new %>% 
  mutate(Infected = Confirmed - Recovered - Deaths)


# 3. Renaming some of the variables to make it more intuitive

ncov_new <- ncov_new %>% 
  rename(Cum_Confirmed = Confirmed,
         Province_State = Province.State,
         Country_Region = Country.Region)

```


```{r Loading of spatial data}

# Note: The following spatial data was obtained by installing the naturalearth packages.

# Steps:

# 1. Loading of the world data (spatial object) 

World <- ne_countries(scale = "medium", returnclass = "sf")
  
```


```{r Making neccessary changes to accomplish merging of ncov_new and World data frames}

# Note: The "Country_Region" variable will be used to join the spatial data frame ("World") and the ncov_new data frame. Therfore, a geometry variable will be added to the ncov_new data frame.  

# Steps:

# 1. Testing to see which country names do NOT coincide between the two data frames.

# 1.1 Creating a data frame (World_df) that list all the countries of the natural earth data.The "pop_est" variable will be used later on for testing purpose.

World_df <- data.frame( Country_Region = World$name_long,
                        Pop_Estimate = World$pop_est)


# 1.2 Joining the ncov_new data frame with the World_df date frame to investigate cases where "pop_est" is NA (i.e to investigate where there is a mis match in country names)

Country_Test_df <- left_join(ncov_new, World_df, by = "Country_Region" )


# Remark: There are NA's present. These country names that cause this will be investigated.

# 1.3 Investigation of the countries that present NA values

 Mismatch_Countries <- Country_Test_df %>%  
   filter(is.na(Pop_Estimate)) %>%
   group_by(Country_Region) %>%
   summarise(count = n())

 # Remark: Luckily, there is only 20 counties that does not coincide. These countries will be manually renamed so that they can be merged successfully.  
 
# 1.4  Change the following names of the ncov_new data set. Format: "old name" -> "new name"

# 1. Brunei -> Brunei Darussalam 
# 2. Congo (Brazzaville) -> Republic of the Congo
# 3. Congo (Kinshasa) -> Democratic Republic of the Congo
# 4. Cote d'Ivoire -> Côte d'Ivoire 
# 5. Diamond Princess -> Japan 
# 6. Czechia -> Czech Republic 
# 7. Eswatini -> eSwati
# 8. Gambia, The ->The Gambia
# 9. Holy See -> Vatican 
# 10. Korea, South -> Republic of Korea 
# 11. North Macedonia -> Macedonia 
# 12. Russia -> Russian Federation 
# 13. Taiwan* -> Taiwan 
# 14. US -> United States 
# 15. Cabo Verde -> Republic of Cabo Verde 
# 16. Burma -> Myanmar 
# 17. Laos -> Lao PDR
# 18. MS Zaandam -> Bahamas
# 19. Sao Tome and Principe -> 	São Tomé and Principe
# 20. West Bank and Gaza -> Palestine

ncov_new$Country_Region[ncov_new$Country_Region == "Brunei"] <- "Brunei Darussalam"

ncov_new$Country_Region[ncov_new$Country_Region == "Congo (Brazzaville)"] <- "Republic of Congo"

ncov_new$Country_Region[ncov_new$Country_Region == "Congo (Kinshasa)"] <- "Democratic Republic of the Congo"

ncov_new$Country_Region[ncov_new$Country_Region == "Cote d'Ivoire"] <- "Côte d'Ivoire"

ncov_new$Country_Region[ncov_new$Country_Region == "Diamond Princess"] <- "Japan"

ncov_new$Country_Region[ncov_new$Country_Region == "Czechia"] <- "Czech Republic"

ncov_new$Country_Region[ncov_new$Country_Region == "Eswatini"] <- "Swaziland"

ncov_new$Country_Region[ncov_new$Country_Region == "Gambia"] <- "The Gambia"

ncov_new$Country_Region[ncov_new$Country_Region == "Holy See"] <- "Vatican"

ncov_new$Country_Region[ncov_new$Country_Region == "Korea, South"] <- "Republic of Korea"

ncov_new$Country_Region[ncov_new$Country_Region == "Russia"] <- "Russian Federation"

ncov_new$Country_Region[ncov_new$Country_Region == "US"] <- "United States"

ncov_new$Country_Region[ncov_new$Country_Region == "Cabo Verde"] <- "Cape Verde"

ncov_new$Country_Region[ncov_new$Country_Region == "North Macedonia"] <- "Macedonia"

ncov_new$Country_Region[ncov_new$Country_Region == "Taiwan*"] <- "Taiwan" 

ncov_new$Country_Region[ncov_new$Country_Region == "Burma"] <- "Myanmar"

ncov_new$Country_Region[ncov_new$Country_Region == "Laos"] <- "Lao PDR" 

ncov_new$Country_Region[ncov_new$Country_Region == "MS Zaandam"] <- "Bahamas" 

ncov_new$Country_Region[ncov_new$Country_Region == "West Bank and Gaza"] <- "Palestine" 

ncov_new$Country_Region[ncov_new$Country_Region == "Sao Tome and Principe"] <- "São Tomé and Principe" 


# 1.5 Re-joining the Country_Test_df with changed country names

Country_Test_df <- left_join(ncov_new, World_df, by = "Country_Region")


# Remark: All the country names of the ncov_new data set and the spatial data set will coincide. The merging of the spatial features can continue.


# 2. Creating Spatial data frame that only contains the important features from the world data set and storing in "World_Merge_df". This spatial data frame will be used in the merging operation in the next code chunk.

World_Merge_df <- World %>% 
  select(name_long,continent) %>%
  rename(Country_Region  = name_long)

```


```{r Merging operation of spatial data}

# Note: The following code chunk deals with creating a data frame that contains the nessecceray data that will be used to create plots of a world map.


# Steps:

# 1. Creating a data frame that summarises the data for each country per day. 

ncov_new_FINAL_data <-  ncov_new %>% 
  group_by(Date, Country_Region) %>% 
  summarise(Cum_Confirmed_Country = sum(Cum_Confirmed),
            Recovered_Country = sum(Recovered),
            Deaths_Country = sum(Deaths),
            Infected_Country = sum(Infected)) %>% 
  as.data.frame()

# Remark: The Province_State varibale was ignored in the analysis since most of the values were missing.

# 2. Merge data frame (ncov_new_FINAL_data) with Spatial data frame (World_Merde_df)

ncov_new_Spatial <- left_join(ncov_new_FINAL_data, World_Merge_df , by = "Country_Region")

# 3. Classifying the geometry feature in data frame.The data frame will then have a class "data frame" and "sf" instead of just a "data frame"

st_geometry(ncov_new_Spatial) <- ncov_new_Spatial$geometry

```


\section{Visualisations}

\subsection{Part 1 - Animation development}


```{r  Intoduction to animation}

# Note: The following code blocks will be associated with creating an animations to give insight on the spread of covid 19 gloabally. Creating a single animation of the world map and showing the 4 variables of interest (cases, deaths, recoveries and infected) of covid 19 is insightful, but there is a lack in detail. Therefore it was decided to make multiple animations (gifs) and zooming into the continents to observe more detail.

# Steps:

# 1. Transform the original ncov_new_spatial data frame into a longer format


ncov_new_Longer_Spatial <- pivot_longer(data = ncov_new_Spatial,
                                       cols = c("Cum_Confirmed_Country", "Recovered_Country", "Deaths_Country", "Infected_Country"),
                                       names_to = "Variable",
                                       values_to = "Data_Value") %>% 
  as.data.frame()

# 2. Identify the data frame as a sf and data frame object

  st_geometry(ncov_new_Longer_Spatial) <- ncov_new_Longer_Spatial$geometry 

```


```{r Creating animation of the world map }

# Steps

# 1. Specifying the position of the labels for each country in the world (counting the number of cases as the date progresses)

World_points <- st_centroid(ncov_new_Longer_Spatial)
World_points <- cbind(ncov_new_Longer_Spatial,
                    st_coordinates(st_centroid(ncov_new_Longer_Spatial$geometry)))

# 2. Plotting world map 

# 2.1 Specifying labels for the facets

Var_labels <- c("Cases", "Deaths", "Recoveries", "Infected")
names(Var_labels) <- c("Cum_Confirmed_Country", "Deaths_Country", "Recovered_Country", "Infected_Country")

# 2.2 Use ggplot() to plot

World_Map <- ggplot() + 
  geom_sf(data = World, fill = "gray48") +
  geom_sf(data = ncov_new_Longer_Spatial, aes(frame = Date, fill = Data_Value)) +
  scale_fill_gradient(low="lightyellow", high="red", trans = "log10") +
  labs(title = "World map", subtitle = "Date: {current_frame}", fill = "Count", x = "Latitude", y = "Longitude" ) + 
  theme(title = element_text(size = 14, face = "bold"), panel.grid.major = element_line(color = "gray65", linetype = "dashed", size = 0.5), panel.background = element_rect(fill = "aliceblue"), strip.text = element_text(size = 11, face = "bold")) +
  facet_wrap(~Variable,
             labeller = labeller(Variable = Var_labels ))

# 3. Creating a gganim object
  
World_Map_anim <-  World_Map  + 
  transition_manual(Date)

# 4. Creating gif 

World_Gif <- animate(World_Map_anim, fps = 5, width = 1000 , height = 1000 )

# 7. Saving the gif created (Maybe should not insert)

anim_save("1.World_Map.gif", animation = World_Gif, path = "C:/Users/Gustav/Desktop/MSc Data Science 1st year/Exploratory data analysis/Assignments/Assignment4" )

```


```{r Creating an animation for Africa}

# Steps:

# 1. Filtering the spatial data frame to only retrieve information about Africa

ncov_new_Spatial_Afr <- ncov_new_Longer_Spatial %>% 
  filter(continent == "Africa")

# 2. Specifying the position of the labels for each country in Europe (counting the number of cases as the date progresses)

World_Points_Afr <- st_centroid(ncov_new_Spatial_Afr)
World_Points_Afr <- cbind(ncov_new_Spatial_Afr,
                    st_coordinates(st_centroid(ncov_new_Spatial_Afr$geometry)))

# 3. Getting data for base map (Africa countries)

Africa_data <- World %>% 
  filter(continent == "Africa")

# 4. Plotting Africa map using ggplot() 

Map_Afr <- ggplot() + 
  geom_sf(data = Africa_data, fill = "gray48") +
  geom_sf(data = ncov_new_Spatial_Afr, aes(frame = Date, fill = Data_Value)) +
  scale_fill_gradient(low="lightyellow", high="red", trans = "log10") +
  geom_text_repel(data = World_Points_Afr, aes(x = X, y = Y, label = Data_Value), check_overlap = FALSE) + 
  labs(title = "Africa", subtitle = "Date: {current_frame}", fill = "Count", x = "Latitude", y = "Longitude" ) + 
  theme(title = element_text(size = 12, face = "bold"), panel.grid.major = element_line(color = "gray65", linetype = "dashed", size = 0.5), panel.background = element_rect(fill = "aliceblue"), strip.text = element_text(size = 11, face = "bold")) +
  facet_wrap(~Variable,
             labeller = labeller(Variable = Var_labels ))

# 5. Creating a gganim object
  
Map_Afr_Anim <-  Map_Afr + 
  transition_manual(Date)

# 6. Creating gif 

Afr_Gif<- animate(Map_Afr_Anim, fps = 2, width = 950, height = 950)

# 7. Saving the gif created (Maybe should not insert)

anim_save("2.Afr.gif", animation = Afr_Gif, path = "C:/Users/Gustav/Desktop/MSc Data Science 1st year/Exploratory data analysis/Assignments/Assignment4" )

```


```{r Creating an animation for Europe}

# Steps:

# 1. Filtering the spatial data frame to only retrieve information about Europe

ncov_new_Spatial_Eur <- ncov_new_Longer_Spatial %>% 
  filter(continent == "Europe")

# 2. Specifying the position of the labels for each country in Europe (counting the number of cases as the date progresses)

World_Points_Eur <- st_centroid(ncov_new_Spatial_Eur)
World_Points_Eur <- cbind(ncov_new_Spatial_Eur,
                    st_coordinates(st_centroid(ncov_new_Spatial_Eur$geometry)))

# 3. Getting data for base map (Europe countries)

Europe_data <- World %>% 
  filter(continent == "Europe")

# 4. Plotting Africa map using ggplot() 

Map_Eur <- ggplot() + 
  geom_sf(data = Europe_data, fill = "gray48") +
  geom_sf(data = ncov_new_Spatial_Eur, aes(frame = Date, fill = Data_Value)) +
  coord_sf(xlim = c(-40, 45), ylim = c(30,75), expand = FALSE) +
  scale_fill_gradient(low="lightyellow", high="red", trans = "log10") +
  geom_text_repel(data = World_Points_Eur, aes(x = X, y = Y, label = Data_Value), check_overlap = FALSE) + 
  labs(title = "Europe", subtitle = "Date: {current_frame}", fill = "Count", x = "Latitude", y = "Longitude" ) + 
  theme(title = element_text(size = 12, face = "bold"), panel.grid.major = element_line(color = "gray65", linetype = "dashed", size = 0.5), panel.background = element_rect(fill = "aliceblue"), strip.text = element_text(size = 11, face = "bold")) +
  facet_wrap(~Variable,
             labeller = labeller(Variable = Var_labels ),
             ncol = 2,
             nrow = 2)

# 5. Creating a gganim object
  
Map_Eur_Anim <-  Map_Eur + 
  transition_manual(Date)

# 6. Creating gif 

 Eur_Gif <- animate(Map_Eur_Anim, fps = 2, width = 950, height = 950)

# 7. Saving the gif created (Maybe should not insert)

anim_save("3.Eur.gif", animation = Eur_Gif, path = "C:/Users/Gustav/Desktop/MSc Data Science 1st year/Exploratory data analysis/Assignments/Assignment4" )

```


```{r Creating an animation for Asia}

# Steps:

# 1. Filtering the spatial data frame to only retrieve information about Asia

ncov_new_Spatial_Asia <- ncov_new_Longer_Spatial %>% 
  filter(continent == "Asia")

# 2. Specifying the position of the labels for each country in Asia (counting the number of cases as the date progresses)

World_Points_Asia <- st_centroid(ncov_new_Spatial_Asia)
World_Points_Asia <- cbind(ncov_new_Spatial_Asia,
                    st_coordinates(st_centroid(ncov_new_Spatial_Asia$geometry)))

# 3. Getting data for base map (Asia countries)

Asia_data <- World %>% 
  filter(continent == "Asia")

# 4. Plotting Asia map using ggplot() 

Map_Asia <- ggplot() + 
  geom_sf(data = Asia_data, fill = "gray48") +
  geom_sf(data = ncov_new_Spatial_Asia, aes(frame = Date, fill = Data_Value)) +
  scale_fill_gradient(low="lightyellow", high="red", trans = "log10") +
  geom_text_repel(data = World_Points_Asia, aes(x = X, y = Y, label = Data_Value), check_overlap = FALSE) + 
  labs(title = "Asia", subtitle = "Date: {current_frame}", fill = "Count", x = "Latitude", y = "Longitude" ) + 
  theme(title = element_text(size = 12, face = "bold"), panel.grid.major = element_line(color = "gray65", linetype = "dashed", size = 0.5), panel.background = element_rect(fill = "aliceblue"), strip.text = element_text(size = 11, face = "bold")) +
  facet_wrap(~Variable,
             labeller = labeller(Variable = Var_labels ))

# 5. Creating a gganim object
  
Map_Asia_Anim <-  Map_Asia + 
  transition_manual(Date)

# 6. Creating gif 

 Asia_Gif <- animate(Map_Asia_Anim, fps = 2, width = 950, height = 950)

# 7. Saving the gif created (Maybe should not insert)

anim_save("4.Asia.gif", animation = Asia_Gif, path = "C:/Users/Gustav/Desktop/MSc Data Science 1st year/Exploratory data analysis/Assignments/Assignment4" )

```


```{r Creating an animation for North America}

# Steps:

# 1. Filtering the spatial data frame to only retrieve information about North America

ncov_new_Spatial_USA <- ncov_new_Longer_Spatial %>% 
  filter(continent == "North America")

# 2. Specifying the position of the labels for each country in North America (counting the number of cases as the date progresses)

World_Points_USA <- st_centroid(ncov_new_Spatial_USA)
World_Points_USA <- cbind(ncov_new_Spatial_USA,
                    st_coordinates(st_centroid(ncov_new_Spatial_USA$geometry)))

# 3. Getting data for base map (North America countries)

USA_data <- World %>% 
  filter(continent == "North America")

# 4. Plotting Africa map using ggplot() 

Map_USA <- ggplot() + 
  geom_sf(data = USA_data, fill = "gray48") +
  geom_sf(data = ncov_new_Spatial_USA, aes(frame = Date, fill = Data_Value)) +
  coord_sf(xlim = c(-135,-50), ylim = c(5, 50), expand = FALSE) +
  scale_fill_gradient(low="lightyellow", high="red", trans = "log10") +
  geom_text_repel(data = World_Points_USA, aes(x = X, y = Y, label = Data_Value), check_overlap = FALSE) + 
  labs(title = "North America", subtitle = "Date: {current_frame}", fill = "Count", x = "Latitude", y = "Longitude" ) + 
  theme(title = element_text(size = 12, face = "bold"), panel.grid.major = element_line(color = "gray65", linetype = "dashed", size = 0.5), panel.background = element_rect(fill = "aliceblue"), strip.text = element_text(size = 11, face = "bold")) +
  facet_wrap(~Variable,
             labeller = labeller(Variable = Var_labels ))

# 5. Creating a gganim object
  
Map_USA_Anim <-  Map_USA + 
  transition_manual(Date)

# 6. Creating gif 

 USA_Gif <- animate(Map_USA_Anim, fps = 2, width = 950, height = 950)

# 7. Saving the gif created (Maybe should not insert)

anim_save("5.USA.gif", animation =  USA_Gif, path = "C:/Users/Gustav/Desktop/MSc Data Science 1st year/Exploratory data analysis/Assignments/Assignment4" )

```

```{r Creating an animation for Oceania}

# Steps:

# 1. Filtering the spatial data frame to only retrieve information about Oceania

ncov_new_Spatial_Oce <- ncov_new_Longer_Spatial %>% 
  filter(continent == "Oceania")

# 2. Specifying the position of the labels for each country in North America (counting the number of cases as the date progresses)

World_Points_Oce <- st_centroid(ncov_new_Spatial_Oce)
World_Points_Oce <- cbind(ncov_new_Spatial_Oce,
                    st_coordinates(st_centroid(ncov_new_Spatial_Oce$geometry)))

# 3. Getting data for base map (Oceania countries)

Oceania_data <- World %>% 
  filter(continent == "Oceania")

# 4. Plotting Oceania map using ggplot() 

Map_Oce <- ggplot() + 
  geom_sf(data = Oceania_data, fill = "gray48") +
  geom_sf(data = ncov_new_Spatial_Oce, aes(frame = Date, fill = Data_Value)) +
  coord_sf(xlim = c(110,190), ylim = c(-60,20), expand = FALSE) +
  scale_fill_gradient(low="lightyellow", high="red", trans = "log10") +
  geom_text(data = World_Points_Oce, aes(x = X, y = Y, label = Data_Value), check_overlap = FALSE, size = 6, fontface = "bold" ) + 
  labs(title = "Oceania", subtitle = "Date: {current_frame}", fill = "Count", x = "Latitude", y = "Longitude" ) + 
  theme(title = element_text(size = 12, face = "bold"), panel.grid.major = element_line(color = "gray65", linetype = "dashed", size = 0.5), panel.background = element_rect(fill = "aliceblue"), strip.text = element_text(size = 11, face = "bold")) +
  facet_wrap(~Variable,
             labeller = labeller(Variable = Var_labels ))

# 5. Creating a gganim object
  
Map_Oce_Anim <-  Map_Oce + 
  transition_manual(Date)

# 6. Creating gif 

Oce_Gif <- animate(Map_Oce_Anim, fps = 2, width = 950, height = 950)

# 7. Saving the gif created (Maybe should not insert)

anim_save("6.Oce.gif", animation =  Oce_Gif, path = "C:/Users/Gustav/Desktop/MSc Data Science 1st year/Exploratory data analysis/Assignments/Assignment4" )

```

```{r Creating an animation for South America }

# Steps:

# 1. Filtering the spatial data frame to only retrieve information about South America

ncov_new_Spatial_SA <- ncov_new_Longer_Spatial %>% 
  filter(continent == "South America")

# 2. Specifying the position of the labels for each country in South America (counting the number of cases as the date progresses)

World_Points_SA <- st_centroid(ncov_new_Spatial_SA)
World_Points_SA <- cbind(ncov_new_Spatial_SA,
                    st_coordinates(st_centroid(ncov_new_Spatial_SA$geometry)))

# 3. Getting data for base map (South America countries)

SA_data <- World %>% 
  filter(continent == "South America")

# 4. Plotting South America map using ggplot() 

Map_SA <- ggplot() + 
  geom_sf(data = SA_data, fill = "gray48") +
  geom_sf(data = ncov_new_Spatial_SA , aes(frame = Date, fill = Data_Value)) +
  scale_fill_gradient(low="lightyellow", high="red", trans = "log10") +
  geom_text(data = World_Points_SA , aes(x = X, y = Y, label = Data_Value), check_overlap = FALSE) + 
  labs(title = "South America", subtitle = "Date: {current_frame}", fill = "Count", x = "Latitude", y = "Longitude" ) + 
  theme(title = element_text(size = 12, face = "bold"), panel.grid.major = element_line(color = "gray65", linetype = "dashed", size = 0.5), panel.background = element_rect(fill = "aliceblue"), strip.text = element_text(size = 11, face = "bold")) +
  facet_wrap(~Variable,
             labeller = labeller(Variable = Var_labels ))

# 5. Creating a gganim object
  
Map_SA_Anim <-  Map_SA + 
  transition_manual(Date)

# 6. Creating gif 

SA_Gif <- animate(Map_SA_Anim, fps = 2, width = 950, height = 950)

# 7. Saving the gif created (Maybe should not insert)

anim_save("7.SAm.gif", animation =  SA_Gif, path = "C:/Users/Gustav/Desktop/MSc Data Science 1st year/Exploratory data analysis/Assignments/Assignment4" )

```


```{r Importing the merged gif file}

# Doesnt seem to work

Covid_19_gif <- read.gif("Ass_4_gif.gif")

```

Part 2: Shiny app development

```{r Introduction to shiny dashboard development}

# Note: The following blocks of code will be associated with the development of the final Shiny dashboard. 

# Steps:

# 1. Saving variables that are going to be used in the shiny application


# 1.1 Creating customised icons for the shiny dashboard 

Death_icon <- awesomeIcons(
  icon = "times-circle",
  library = "fa",
  iconColor = "black",
  markerColor = "red"
)

Recovery_icon <- awesomeIcons(
  icon = "ambulance",
  library = "fa",
  iconColor = "black",
  markerColor = "green"
)

# 1.2  Adding the continent variable to the existing ncov_new_Final_data data frame

 # 1.2.1 Retrieving continents data from World_Merge_df (used earlier)

World_Merge_No_Geom <- World_Merge_df %>% 
  st_set_geometry(value = NULL)

 # 1.2.2 Joining the two data frames

Continents_data <- left_join(ncov_new_FINAL_data, World_Merge_No_Geom, by = "Country_Region") %>%
  group_by(Date, continent) %>% 
      summarise(Cum_Confirmed_Country = sum(Cum_Confirmed_Country),
            Recovered_Country = sum(Recovered_Country),
            Deaths_Country = sum(Deaths_Country),
            Infected_Country = sum(Infected_Country)) %>% 
  rename(Country_Region = continent) %>% 
  as.data.frame()

 # 1.2.3 Adding the continents data to the original data frame

ncov_new_FINAL_data_Plot <- rbind(Continents_data, ncov_new_FINAL_data)



# 1.3 Extracting country and continent names (for select input)


Country_Names <- levels(as.factor(ncov_new_FINAL_data$Country_Region))

Continent_Names <- levels(as.factor(Continents_data$Country_Region))

Country_Region_Names <- c(Continent_Names, Country_Names)

# 1.4 Filtering to the desired date of user to reveal map and creating colour pallet

Map_Data <- ncov_new_Spatial %>% 
  filter(Date == max(ncov_new_FINAL_data$Date)) # last updated date of data set

Countries_pal <- colorNumeric(palette = "Reds",
                              domain = log(Map_Data$Cum_Confirmed_Country))


# 1.5 Frequency data set of ncov cases

# 1.5.1  Create "day counter" (ref) for data set

ref <- data.frame("Date" = unique(ncov_new_FINAL_data$Date), 
                  "Day" = c(1:85))

# 1.5.2  Merge ref with ncov_new_FINAL_data

merge <- left_join(ncov_new_FINAL_data, ref, by = "Date")

# 1.5.3 Create new columns for individual frequency counts

ncov_freq_df <- add_column(merge,
                     "freq_Confirmed" = rep(0,nrow(merge)),
                     "freq_Deaths" = rep(0,nrow(merge)),
                     "freq_Recovered" = rep(0,nrow(merge)),
                     "freq_Infected" = rep(0,nrow(merge)),
                     )

test <- ncov_freq_df[order(ncov_freq_df$Country_Region),]

for(i in 1:nrow(test)){
  
  if(test$Day[i] == 1){
    test$freq_Confirmed[i] <- test$Cum_Confirmed_Country[i]
    test$freq_Deaths[i] <- test$Deaths_Country[i]
    test$freq_Recovered[i]<- test$Recovered_Country[i]
    test$freq_Infected[i] <- test$Infected_Country[i]
  
  }else{
    test$freq_Confirmed[i] <- test$Cum_Confirmed_Country[i]-test$Cum_Confirmed_Country[i-1]
    test$freq_Deaths[i] <- test$Deaths_Country[i] - test$Deaths_Country[i-1]
    test$freq_Recovered[i]<- test$Recovered_Country[i] - test$Recovered_Country[i-1]
    test$freq_Infected[i] <- test$Infected_Country[i] - test$Infected_Country[i-1]
    }
}

```
 
Begin app here!
```{r Defining ui and server of shiny dashboard}

# Note: The shinydashboard package was used to construct the layout of the dashboard. 

# Steps

# 1. Defining structure of the UI

# 1.1 Adding dashboard header 

header <- dashboardHeader(
  title = "Covid 19 - 23/03/2020",
  titleWidth = 250
)

# 1.2 Adding a sidebar to dashboard

sidebar <- dashboardSidebar(
  
  # Adding tabs to the sidebar in the dashboard
  
  collapsed = TRUE, # Setting the deafault of the sidebar to close
  
  # Adding tabs to the sidebar in the dashboard
  
  sidebarMenu( 
    menuItem("Word Data",
             tabName = "world_data", icon = icon("globe")),
    menuItem("Country/Region Data",
             tabName = "country_region_data", icon = icon("chart-bar"))
 )
)

# 1.3 Adding body to dashboard

body <- dashboardBody(

  # 1.3.1 Linking the tabs created in the sidebar to reflect in the body of the dashboard  
  
  tabItems(
    tabItem(tabName = "world_data", # Elements in included in the first tab
            
# Vlalue boxes will display the cases, deaths, recoveries and infected variables

            fluidRow(
              column( width = 3,
                      valueBoxOutput("G_Confirmed_Cases",
                                     width = NULL)
                      ),
              
              column( width = 3,
                      valueBoxOutput("G_deaths",
                                     width = NULL)
                      ),
  
              column(width = 3,
                     valueBoxOutput("G_Recoveries",
                                    width = NULL)
                     ),
              
              column(width = 3,
                     valueBoxOutput("G_Infected",
                                    width = NULL))
              ),
   
   fluidRow(
     
     # Space for Map output
     
     leafletOutput("World_Map", height = 550)
     ),
   
   fluidRow(
     column(width = 6,
            align = "center",
            setSliderColor("red", 1),
            sliderInput("date","Select data extraction date:", # Creating slider date input
                        min = as.Date("2020-01-22","%Y-%m-%d"),
                        max = as.Date("2020-03-23","%Y-%m-%d"),
                        value=as.Date("2020-03-23"),
                        timeFormat="%Y-%m-%d")
            ),
     
     column(width = 6,
            align = "left",
            prettyRadioButtons(inputId = "topTen", # Creating radio button input
                            label = "Additional information w.r.t chosen date:",
                            choices = c("Normal world map", "Top ten regions with highest death count", "Top ten regions with the higest recovery count"),
                            shape = "round", 
                            status = "danger",
                            fill = TRUE, 
                            animation = "pulse")
            )
     )
   ),

tabItem(tabName = "country_region_data",
        sidebarLayout(
          sidebarPanel(
            selectInput(inputId = "country_continent", # For country/region input
                        "Select Country/Continent:",
                        choices = Country_Region_Names ,
                        selected = "South Africa", 
                        multiple = TRUE),
            
            prettyRadioButtons(inputId = "DataSelection", # For variable input
                          label = "Select data interest:", 
                          icon = icon("check-circle"),
                          choiceNames = c("Cumulative cases", "Deaths", "Recoveries", "Infected"),
                          choiceValues = c("Cum_Confirmed_Country", "Deaths_Country", "Recovered_Country", "Infected_Country"),
                          selected = "Cum_Confirmed_Country",
                          animation = "tada", 
                          status = "danger"),
            
            materialSwitch(inputId = "logScale", # To enable log-scale
                           label = "Activate log scale:",
                           status = "danger"
                           ),
            
            materialSwitch(inputId = "area", # To enable area graph
                           label = "Activate area graph:",
                           status = "danger"
                           )
            ),
          mainPanel(
            plotlyOutput("countryPlot"), # Interactive plot of country/region
            plotlyOutput("FreqPlot")) # Interactive plot of dayly frequencies 
          )
        )
 )
)

# 1.4 Saving all elements created to the UI

ui <- dashboardPage(header, sidebar, body, skin = "black")


# 2. Define elements in server

server <- function(input, output){

# 2.1. Saving reactive variables (minimising duplication of code)
  
# 2.1.1 Data set used for value box inputs
  
ncov_reactive_data <-  reactive({
  ncov_new_FINAL_data %>% 
    filter(Date == input$date)
})

# 2.1.2 Data used to determine top 10 regions with highest recovery/death rate

Top10Deaths <- reactive({ 
  ncov_new %>%
  filter(Date == input$date) %>% 
  arrange(desc(Deaths)) %>% 
  head(10) %>% 
  mutate(Rank = seq(1,10, by = 1))
})

Top10Recoveries <- reactive({
  ncov_new %>%
  filter(Date == input$date) %>% 
  arrange(desc(Recovered)) %>% 
  head(10) %>% 
  mutate(Rank = seq(1,10, by = 1))
})

# 2.1.3 New variable intorduced ncov_final_data_plot (includes continent data)
   
  data <- reactive({  
    ncov_new_FINAL_data_Plot %>%
      filter(Country_Region %in% input$country_continent)
  })

# 2.2 Specifying data to use for value box output

# 2.2.1 Value box 1 output 

output$G_Confirmed_Cases <- renderValueBox({
  Confirmed <-  ncov_reactive_data() %>% 
    select(Cum_Confirmed_Country) %>% 
    sum()
  
  valueBox(value = Confirmed,
           subtitle = "Global confirmed cases",
           icon = icon("globe", lib = "glyphicon"), color = "red")
  })

# 2.2.2 Value box 2 output

output$G_deaths <- renderValueBox({
  Deaths <- ncov_reactive_data() %>%
    select(Deaths_Country) %>% 
    sum()
  
  valueBox(value = Deaths,
           subtitle = "Global deaths",
           icon = icon("remove-sign", lib = "glyphicon"), color = "red")
})

# 2.2.3 Value box 3 output

output$G_Recoveries <- renderValueBox({
  
  Recoveries <- ncov_reactive_data() %>% 
    select(Recovered_Country) %>% 
    sum()
  
  valueBox(value = Recoveries,
           subtitle = "Global recoveries",
           icon = icon("heart", lib = "glyphicon"), color = "red")
})

# 2.2.4 Value box 4 output

output$G_Infected <- renderValueBox({
  
  Infected <- ncov_reactive_data() %>% 
    select(Infected_Country) %>% 
    sum()
  
  valueBox(value = Infected,
           subtitle = "Global infected cases",
           icon = icon("stethoscope", lib = "font-awesome"), color = "red")
})

# 2.3 Data for World map output

output$World_Map <- renderLeaflet({ 
  
  L_World_Map <- ncov_new_Spatial %>%
    filter(Date == input$date) %>% 
     leaflet(options = leafletOptions(minZoom = 2.5)) %>% 
       addProviderTiles(provider = "CartoDB.Positron", options = providerTileOptions( noWrap = TRUE) ) %>%  
       addPolygons(weight = 1,
                   fillOpacity = 0.2,
                   color = ~Countries_pal(log(Cum_Confirmed_Country)),
                   popup = ~paste0("<b>", Country_Region, "</b>","<br/>",
                                   "Cases:", Cum_Confirmed_Country,"<br/>",
                                   "Deaths:", Deaths_Country, "<br/>",
                                   "Recoveries:", Recovered_Country,"<br/>",
                                   "Infected:", Infected_Country),
                   highlight = highlightOptions(weight = 3,
                                                color = "red",
                                                bringToFront = TRUE)
       ) %>% 
       setMaxBounds(lat1 = -90, lat2 = 90, lng1 = -180, lng2 = 180) %>% 
       setView(lat = 8.0817, lng = 17.6078, zoom = 2.5)
  
   if(input$topTen == "Normal world map") {
    
    L_World_Map
     
     }
  
  if(input$topTen == "Top ten regions with highest death count") {
  
    Long <- Top10Deaths() %>% 
      select(Long)
    
    Lat <- Top10Deaths() %>% 
      select(Lat)
    
    Rank <- Top10Deaths() %>% 
      select(Rank)
    
    Deaths <- Top10Recoveries() %>% 
      select(Deaths)
    
    L_World_Map <- L_World_Map %>% 
      addAwesomeMarkers(lng = Long,
                        lat = Lat, 
                        icon = Death_icon, 
                        popup = ~paste0("<b>", "Rank:", Rank, "</b>", "<br/>", "<b>", "Deaths:", "</b>", Deaths))
    
    }
  
  if(input$topTen == "Top ten regions with the higest recovery count") {
    
    Long <- Top10Recoveries() %>% 
      select(Long)
    
    Lat <- Top10Recoveries() %>% 
      select(Lat)
    
    Rank <- Top10Recoveries() %>% 
      select(Rank)
    
    Recovered <- Top10Recoveries() %>% 
      select(Recovered)
    
   L_World_Map <- L_World_Map %>% 
      addAwesomeMarkers(lng = Long,
                        lat = Lat,
                        icon = Recovery_icon,
                        popup = ~paste0("<b>", "Rank:", Rank, "</b>", "<br/>", "<b>", "Recoveries:", "</b>", Recovered))
   
   }
 
  L_World_Map
  
  })



# 2.4 Plotly output


output$countryPlot <- renderPlotly({

  
if(input$DataSelection == "Cum_Confirmed_Country") {
  
  data <-  data() %>% 
    filter(Cum_Confirmed_Country != 0)
  
  y <- data() %>%
    select(Cum_Confirmed_Country)
  
  Plot <- ggplot(data, aes(x = Date, y = Cum_Confirmed_Country , fill = Country_Region)) +
    geom_col(aes(text = paste0('</br> Cumalative cases: ', Cum_Confirmed_Country,'</br> Date: ', Date, '</br> Country: ', Country_Region)), position = "dodge") +
    labs(y = "Cummalative cases", fill = "Region") +
    theme_bw()
}
  
if(input$DataSelection == "Deaths_Country") {
  
  data <-  data() %>% 
    filter(Deaths_Country != 0)
  
  y <- data() %>% 
    select(Deaths_Country)
  
  Plot <- ggplot(data, aes(x = Date, y = Deaths_Country, fill = Country_Region)) +
    geom_col(aes(text = paste0('</br> Deaths: ', Deaths_Country,'</br> Date: ', Date, '</br> Country: ', Country_Region)), position = "dodge") +
    labs(y = "Deaths", fill = "Region") +
    theme_bw()
}

if(input$DataSelection == "Recovered_Country") {
  
  data <-  data() %>% 
    filter(Recovered_Country != 0)
  
  y <- data() %>% 
    select(Recovered_Country)
  
  Plot <- ggplot(data, aes(x = Date, y = Recovered_Country, fill = Country_Region)) +
    geom_col(aes(text = paste0('</br> Recoveries: ', Recovered_Country,'</br> Date: ', Date, '</br> Country: ', Country_Region)), position = "dodge") +
    labs(y = "Recoveries", fill = "Region") +
    theme_bw()
    
}
  
if(input$DataSelection == "Infected_Country") {
  
  data <-  data() %>% 
    filter(Infected_Country != 0)
  
  
  y <- data() %>%
    select(Infected_Country)
  
  Plot <- ggplot(data, aes(x = Date, y = Infected_Country, fill = Country_Region)) +
    geom_col(aes(text = paste0('</br> Infected: ', Infected_Country,'</br> Date: ', Date, '</br> Country: ', Country_Region)), position = "dodge") +
    labs(y = "Infected", fill = "Region") +
    theme_bw()
}

  if(input$logScale){
    
  Plot <-  Plot + scale_y_log10() 
    
  }
  
  if(input$area){

Plot <- Plot %>% 
  remove_geom(geom = "col")

Plot <- Plot + geom_area(alpha = 0.6, 
                         position = "identity",
                         aes(fill = fct_reorder(Country_Region, y, .desc = TRUE)))

  }
  
if(input$area)  {
    
  ggplotly(Plot, tooltip = c("y","x")) %>% 
    layout(hovermode = "compare")
}
  else{
    ggplotly(Plot, tooltip = "text") %>% 
    layout(hovermode = "compare")
  }
  
 })

 
}

shinyApp(ui = ui, server = server )

```

**** Example ****


As seen by figure \ref{fig:Normal_Distribution}, the normal distribution is plotted.
Remember the default figure width height is 6 x 4.5 

```{r Normal_Distribution, fig.height= 3, fig.width=4.5 , fig.align='center', fig.cap= "The normal distribution curve", echo=FALSE}

x <- rnorm(100)

hist(x)

ncov_new_FINAL_data %>%
  filter(Date == "2020-03-23") %>% 
  select(Cum_Confirmed_Country) %>%
    sum()
  


```


\pagebreak

\section{References}

